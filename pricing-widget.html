<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background: #f5f5f5;
        }
        .apartment {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #C9B986;
        }
        .label {
            color: #666;
            font-weight: bold;
        }
        .value {
            color: #000;
            background: #ffffcc;
            padding: 2px 5px;
        }
    </style>
</head>
<body>
    <h1>Property REF Debug</h1>
    <div id="output">Loading...</div>

    <script>
        const MONDAY_API_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjE4NDEzNjc3MiwidWlkIjoyNTA1OTE2OSwiaWFkIjoiMjAyMi0xMC0wM1QxNjo1OTo0My44MTJaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6MTAwNzQyNDUsInJnbiI6InVzZTEifQ.x9zltqwDc38J_rbuFt5jg3Ea-3Wq9b4s4yFBrnFuix8';
        const BOARD_ID = 2388987554;
        
        async function debugPropertyRefs() {
            document.getElementById('output').innerHTML = '<p>Loading all apartments (this may take a moment)...</p>';
            
            let allItems = [];
            let cursor = null;
            let hasMore = true;
            
            try {
                // Fetch all items using pagination
                while (hasMore) {
                    const query = `query {
                        boards(ids: ${BOARD_ID}) {
                            items_page(limit: 100${cursor ? `, cursor: "${cursor}"` : ''}) {
                                cursor
                                items {
                                    id
                                    name
                                    column_values {
                                        id
                                        text
                                    }
                                }
                            }
                        }
                    }`;

                    const response = await fetch('https://api.monday.com/v2', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': MONDAY_API_TOKEN,
                            'API-Version': '2024-01'
                        },
                        body: JSON.stringify({ query })
                    });

                    const data = await response.json();
                    
                    if (data.errors) {
                        document.getElementById('output').innerHTML = `<div style="color: red;">ERROR: ${data.errors[0].message}</div>`;
                        return;
                    }
                    
                    const pageData = data.data.boards[0].items_page;
                    allItems = allItems.concat(pageData.items);
                    
                    cursor = pageData.cursor;
                    hasMore = pageData.items.length === 100;
                    
                    document.getElementById('output').innerHTML = `<p>Loading... ${allItems.length} apartments loaded so far...</p>`;
                }
                
                // Now display all items
                let output = `<p><strong>Total apartments found: ${allItems.length}</strong></p>`;
                output += `<div style="margin: 20px 0;"><input type="text" id="searchBox" placeholder="Search apartment name or Property REF..." style="width: 100%; padding: 10px; font-size: 16px;" onkeyup="filterApartments()"></div>`;
                output += `<div id="apartmentList">`;
                
                allItems.forEach((item, index) => {
                    const propRefCol = item.column_values.find(col => col.id === 'item_id');
                    const priceCol = item.column_values.find(col => col.id === 'formula_mkzm99hj');
                    
                    output += `<div class="apartment" data-name="${item.name.toLowerCase()}" data-ref="${propRefCol ? propRefCol.text : ''}">`;
                    output += `<div><span class="label">Apartment ${index + 1}:</span> ${item.name}</div>`;
                    output += `<div><span class="label">Monday Item ID:</span> <span class="value">${item.id}</span></div>`;
                    output += `<div><span class="label">Property REF (column 'item_id'):</span> <span class="value">${propRefCol ? propRefCol.text : 'NOT FOUND'}</span></div>`;
                    output += `<div><span class="label">Price:</span> ${priceCol ? 'Â£' + priceCol.text : 'N/A'}</div>`;
                    output += `</div>`;
                });
                
                output += `</div>`;
                document.getElementById('output').innerHTML = output;
                
            } catch (error) {
                document.getElementById('output').innerHTML = `<div style="color: red;">ERROR: ${error.message}</div>`;
            }
        }
        
        function filterApartments() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const apartments = document.querySelectorAll('.apartment');
            
            apartments.forEach(apt => {
                const name = apt.getAttribute('data-name');
                const ref = apt.getAttribute('data-ref').toLowerCase();
                
                if (name.includes(searchTerm) || ref.includes(searchTerm)) {
                    apt.style.display = 'block';
                } else {
                    apt.style.display = 'none';
                }
            });
        }

        window.addEventListener('DOMContentLoaded', debugPropertyRefs);
    </script>
</body>
</html>
